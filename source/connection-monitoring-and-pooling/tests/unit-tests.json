{
  "version": 1,
  "style": "unit",
  "tests": [
    {
      "description": "must be able to acquire a connection",
      "operations": [
        {
          "command": "createPool",
          "returnTo": "pool"
        },
        {
          "command": "acquire",
          "object": "pool"
        }
      ],
      "events": [
        {
          "type": "connectionPoolQueueEntered",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          }
        }
      ],
      "ignore": [
        "connectionCreated",
        "connectionPoolCreated"
      ]
    },
    {
      "description": "must be able to acquire multiple connections at the same time",
      "operations": [
        {
          "command": "createPool",
          "returnTo": "pool"
        },
        {
          "command": "start",
          "args": [
            "t1"
          ]
        },
        {
          "command": "start",
          "args": [
            "t2"
          ]
        },
        {
          "command": "start",
          "args": [
            "t3"
          ]
        },
        {
          "command": "acquire",
          "thread": "t1",
          "object": "pool",
          "returnTo": "conn1"
        },
        {
          "command": "acquire",
          "thread": "t2",
          "object": "pool",
          "returnTo": "conn2"
        },
        {
          "command": "acquire",
          "thread": "t3",
          "object": "pool",
          "returnTo": "conn3"
        },
        {
          "command": "waitFor",
          "args": [
            "t1"
          ]
        },
        {
          "command": "waitFor",
          "args": [
            "t2"
          ]
        },
        {
          "command": "waitFor",
          "args": [
            "t3"
          ]
        }
      ],
      "events": [
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": 0
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": 1
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": 2
          }
        }
      ],
      "ignore": [
        "connectionCreated",
        "connectionPoolCreated",
        "connectionPoolQueueEntered"
      ]
    },
    {
      "description": "must not be able to acquire more than maxPoolSize connections",
      "operations": [
        {
          "command": "createPool",
          "args": [
            {
              "maxPoolSize": 2,
              "waitQueueTimeoutMS": 20
            }
          ],
          "returnTo": "pool"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn1"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn2"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn3"
        }
      ],
      "events": [
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": {
              "$$ref": [
                "conn1",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": {
              "$$ref": [
                "conn2",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionPoolQueueTimeout",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          }
        }
      ],
      "ignore": [
        "connectionCreated",
        "connectionPoolCreated",
        "connectionPoolQueueEntered"
      ],
      "error": {
        "message": "Timed out while acquiring a connection from connection pool"
      }
    },
    {
      "description": "must create a connection when acquiring if there are no available connections and total connections < maxPoolSize",
      "operations": [
        {
          "command": "createPool",
          "args": [
            {
              "minPoolSize": 0
            }
          ],
          "returnTo": "pool"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn1"
        }
      ],
      "events": [
        {
          "type": "connectionCreated",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": {
              "$$ref": [
                "conn1",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": {
              "$$ref": [
                "conn1",
                "id"
              ]
            }
          }
        }
      ],
      "ignore": [
        "connectionPoolCreated",
        "connectionPoolQueueEntered"
      ]
    },
    {
      "description": "must be able to acquire connections when they are freed",
      "operations": [
        {
          "command": "createPool",
          "args": [
            {
              "maxPoolSize": 3
            }
          ],
          "returnTo": "pool"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn1"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn2"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn3"
        },
        {
          "command": "release",
          "object": "pool",
          "args": [
            {
              "$$ref": [
                "conn2"
              ]
            }
          ]
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn4"
        }
      ],
      "events": [
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": {
              "$$ref": [
                "conn1",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": {
              "$$ref": [
                "conn2",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": {
              "$$ref": [
                "conn3",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionPoolRelease",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": {
              "$$ref": [
                "conn2",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": {
              "$$ref": [
                "conn2",
                "id"
              ]
            }
          }
        }
      ],
      "ignore": [
        "connectionPoolCreated",
        "connectionPoolQueueEntered",
        "connectionCreated"
      ]
    },
    {
      "description": "must not be able to acquire stale connections",
      "operations": [
        {
          "command": "createPool",
          "args": [
            {
              "minPoolSize": 1
            }
          ],
          "returnTo": "pool"
        },
        {
          "command": "clear",
          "object": "pool"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn1"
        }
      ],
      "events": [
        {
          "type": "connectionCreated",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": 0
          }
        },
        {
          "type": "connectionPoolCleared"
        },
        {
          "type": "connectionPoolQueueEntered"
        },
        {
          "type": "connectionDestroyed",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": 0
          }
        },
        {
          "type": "connectionCreated",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": 1
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": 1
          }
        }
      ],
      "ignore": [
        "connectionPoolCreated"
      ]
    },
    {
      "description": "must not enter waitQueue if waitQueue is already at max capacity",
      "operations": [
        {
          "command": "createPool",
          "args": [
            {
              "maxPoolSize": 1,
              "waitQueueSize": 1
            }
          ],
          "returnTo": "pool"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn1"
        },
        {
          "command": "start",
          "args": [
            "t1"
          ]
        },
        {
          "command": "acquire",
          "thread": "t1",
          "object": "pool",
          "returnTo": "conn2"
        },
        {
          "command": "wait",
          "args": [
            10
          ]
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn3"
        }
      ],
      "events": [
        {
          "type": "connectionPoolQueueEntered"
        },
        {
          "type": "connectionPoolAcquire"
        },
        {
          "type": "connectionPoolQueueEntered"
        },
        {
          "type": "connectionPoolQueueFull"
        }
      ],
      "ignore": [
        "connectionCreated",
        "connectionPoolCreated"
      ],
      "error": {
        "message": "Attempted to acquire a connection from connection pool while waitQueue was full"
      }
    },
    {
      "description": "must release a non-stale connection back to the pool",
      "operations": [
        {
          "command": "createPool",
          "args": [
            {
              "minPoolSize": 1
            }
          ],
          "returnTo": "pool"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn1"
        },
        {
          "command": "release",
          "object": "pool",
          "args": [
            {
              "$$ref": [
                "conn1"
              ]
            }
          ]
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn1"
        }
      ],
      "events": [
        {
          "type": "connectionPoolCreated",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionCreated",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": 0
          }
        },
        {
          "type": "connectionPoolQueueEntered",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            },
            "availableConnectionCount": 0,
            "totalConnectionCount": 1
          },
          "connection": {
            "id": 0
          }
        },
        {
          "type": "connectionPoolRelease",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          },
          "connection": {
            "id": 0
          }
        },
        {
          "type": "connectionPoolQueueEntered",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            }
          }
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            },
            "totalConnectionCount": 1
          },
          "connection": {
            "id": 0
          }
        }
      ]
    },
    {
      "description": "must destroy a stale connection when it is released",
      "operations": [
        {
          "command": "createPool",
          "args": [
            {
              "minPoolSize": 1
            }
          ],
          "returnTo": "pool"
        },
        {
          "command": "acquire",
          "object": "pool",
          "returnTo": "conn1"
        },
        {
          "command": "clear",
          "object": "pool"
        },
        {
          "command": "release",
          "object": "pool",
          "args": [
            {
              "$$ref": [
                "conn1"
              ]
            }
          ]
        }
      ],
      "events": [
        {
          "type": "connectionPoolCreated",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            },
            "generation": 0
          }
        },
        {
          "type": "connectionCreated",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            },
            "generation": 0
          },
          "connection": {
            "id": 0
          }
        },
        {
          "type": "connectionPoolQueueEntered"
        },
        {
          "type": "connectionPoolAcquire",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            },
            "generation": 0
          },
          "connection": {
            "id": 0,
            "generation": 0
          }
        },
        {
          "type": "connectionPoolCleared",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            },
            "generation": 1
          }
        },
        {
          "type": "connectionPoolRelease",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            },
            "generation": 1
          },
          "connection": {
            "id": 0,
            "generation": 0
          }
        },
        {
          "type": "connectionDestroyed",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            },
            "generation": 1
          },
          "connection": {
            "id": 0,
            "generation": 0
          }
        }
      ]
    },
    {
      "description": "must clear the pool",
      "operations": [
        {
          "command": "createPool",
          "returnTo": "pool"
        },
        {
          "command": "clear",
          "object": "pool"
        }
      ],
      "events": [
        {
          "type": "connectionPoolCreated",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            },
            "generation": 0
          }
        },
        {
          "type": "connectionPoolCleared",
          "pool": {
            "id": {
              "$$ref": [
                "pool",
                "id"
              ]
            },
            "generation": 1
          }
        }
      ]
    }
  ]
}
