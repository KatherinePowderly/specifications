version: 1
style: unit
description: must destroy and must not acquire a stale connection if found while iterating available connections
poolOptions:
  minPoolSize: 3
operations:
  - name: wait
    ms: 20
  - name: clear
  - name: acquire
events:
  - type: connectionPoolCreated
    pool:
      generation: 0
  - type: connectionCreated
    connection:
      id: 1
      generation: 0
  - type: connectionCreated
    connection:
      id: 2
      generation: 0
  - type: connectionCreated
    connection:
      id: 3
      generation: 0
  - type: connectionPoolCleared
    pool:
      generation: 1
  - type: connectionAcquisitionStarted

  # Note: we cannot deterministically assert which connections get destroyed in which order,
  # just that they will all be destroyed before connection acquisition.
  - type: connectionClosed
    reason: stale
  - type: connectionClosed
    reason: stale
  - type: connectionClosed
    reason: stale
  - type: connectionCreated
    connection:
      id: 4
      generation: 1
  - type: connectionAcquired
    connection:
      id: 4
      generation: 1